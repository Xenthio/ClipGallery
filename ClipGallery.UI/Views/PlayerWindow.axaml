<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:ClipGallery.UI.ViewModels"
        xmlns:vlc="using:LibVLCSharp.Avalonia"
        xmlns:controls="using:ClipGallery.UI.Controls"
        x:Class="ClipGallery.UI.Views.PlayerWindow"
        x:DataType="vm:PlayerViewModel"
        Width="1280" Height="720"
        MinWidth="640" MinHeight="480"
        WindowStartupLocation="CenterScreen"
        Background="#0A0A0A"
        Title="{Binding CurrentClip.FileName, StringFormat='ClipGallery - {0}'}">
    
    <Window.Styles>
        <Style Selector="Button.ctrl-btn">
            <Setter Property="Background" Value="#2a2a2a"/>
            <Setter Property="Foreground" Value="#CCC"/>
            <Setter Property="Padding" Value="10,8"/>
            <Setter Property="CornerRadius" Value="6"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="MinWidth" Value="36"/>
        </Style>
        <Style Selector="Button.ctrl-btn:pointerover">
            <Setter Property="Background" Value="#3a3a3a"/>
        </Style>
        <Style Selector="Button.export-btn">
            <Setter Property="Background" Value="#0088DD"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="14,8"/>
            <Setter Property="CornerRadius" Value="6"/>
            <Setter Property="BorderThickness" Value="0"/>
        </Style>
        <Style Selector="Button.export-btn:pointerover">
            <Setter Property="Background" Value="#00AAFF"/>
        </Style>
    </Window.Styles>
    
    <Grid RowDefinitions="*, Auto, Auto">
        <!-- VIDEO AREA -->
        <vlc:VideoView MediaPlayer="{Binding Player}" Grid.Row="0"/>
        
        <!-- Keyboard hints overlay -->
        <Border Grid.Row="0" HorizontalAlignment="Left" VerticalAlignment="Bottom" 
                Background="#60000000" CornerRadius="4" Padding="8,5" Margin="10" Opacity="0.7">
            <TextBlock Text="Space: Play  |  â†â†’: Seek  |  â†‘â†“: Vol  |  Esc: Close" 
                       FontSize="10" Foreground="#888"/>
        </Border>
        
        <!-- PLAYBACK + TIMELINE with trim region -->
        <Border Grid.Row="1" Background="#E8101010" Padding="16,12" BorderBrush="#333" BorderThickness="0,1,0,0">
            <Grid ColumnDefinitions="Auto, Auto, *, Auto">
                <!-- Play button -->
                <Button Grid.Column="0" Classes="ctrl-btn" Command="{Binding TogglePlayPauseCommand}" 
                        ToolTip.Tip="Play/Pause (Space)" Margin="0,0,12,0">
                    <TextBlock Text="â¯" FontSize="16"/>
                </Button>
                
                <!-- Current time -->
                <TextBlock Grid.Column="1" Text="{Binding CurrentTimeDisplay}" Foreground="#AAA" 
                           VerticalAlignment="Center" FontFamily="Consolas" FontSize="12" Width="45"/>
                
                <!-- Timeline with trim region overlay -->
                <Grid Grid.Column="2" Margin="8,0">
                    <!-- Background track -->
                    <Border Background="#333" Height="6" VerticalAlignment="Center" CornerRadius="3"/>
                    
                    <!-- Trim region highlight (positioned based on TrimStart/TrimEnd) -->
                    <Grid Grid.Column="2">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="{Binding TrimStartGridLength}"/>
                            <ColumnDefinition Width="{Binding TrimMiddleGridLength}"/>
                            <ColumnDefinition Width="{Binding TrimEndGridLength}"/>
                        </Grid.ColumnDefinitions>
                        <Border Grid.Column="0" Background="Transparent"/>
                        <Border Grid.Column="1" Background="#4CAF50" Height="6" Opacity="0.4" 
                                CornerRadius="3" VerticalAlignment="Center"/>
                        <Border Grid.Column="2" Background="Transparent"/>
                    </Grid>
                    
                    <!-- Playback position slider -->
                    <Slider Minimum="0" Maximum="1" Value="{Binding Position}" VerticalAlignment="Center"/>
                </Grid>
                
                <!-- Total time -->
                <TextBlock Grid.Column="3" Text="{Binding TotalTimeDisplay}" Foreground="#AAA" 
                           VerticalAlignment="Center" FontFamily="Consolas" FontSize="12" 
                           Width="45" TextAlignment="Right"/>
            </Grid>
        </Border>

        <!-- CONTROLS ROW -->
        <Border Grid.Row="2" Background="#181818" Padding="16,10">
            <Grid ColumnDefinitions="Auto, Auto, Auto, *, Auto, Auto, Auto, Auto">
                
                <!-- Volume -->
                <Border Grid.Column="0" Background="#222" CornerRadius="6" Padding="10,6" Margin="0,0,8,0">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <TextBlock Text="ðŸ”Š" Foreground="#888" VerticalAlignment="Center" FontSize="12"/>
                        <Slider Minimum="0" Maximum="100" Value="{Binding MainVolume}" 
                                Width="70" VerticalAlignment="Center"/>
                    </StackPanel>
                </Border>

                <!-- Mic Volume (if multi-track) -->
                <Border Grid.Column="1" Background="#222" CornerRadius="6" Padding="10,6" Margin="0,0,8,0"
                        IsVisible="{Binding CurrentClip.Model.HasMultiTrackAudio}">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <TextBlock Text="ðŸŽ¤" Foreground="#888" VerticalAlignment="Center" FontSize="12"/>
                        <Slider Minimum="0" Maximum="1" Value="{Binding SecondaryVolume}" 
                                Width="70" VerticalAlignment="Center"/>
                    </StackPanel>
                </Border>

                <!-- Rating -->
                <controls:RatingControl Grid.Column="2" Value="{Binding RatingInput}" Height="20" Margin="0,0,8,0"/>

                <!-- Tags Button -->
                <Button Grid.Column="3" Classes="ctrl-btn" ToolTip.Tip="Edit Tags" HorizontalAlignment="Left">
                    <Button.Flyout>
                        <Flyout Placement="Top">
                            <Border Background="#1a1a1a" CornerRadius="8" Padding="14" MinWidth="220">
                                <StackPanel Spacing="10">
                                    <TextBlock Text="Tags" FontWeight="SemiBold" Foreground="#CCC" FontSize="13"/>
                                    <TextBox Text="{Binding TagsInput}" Watermark="tag1, tag2..." 
                                             Background="#222" BorderThickness="1" BorderBrush="#444"
                                             Padding="8,6" CornerRadius="4"/>
                                    <Button Content="Save" Command="{Binding SaveMetadataCommand}"
                                            Classes="ctrl-btn" HorizontalAlignment="Right" Padding="12,6"/>
                                </StackPanel>
                            </Border>
                        </Flyout>
                    </Button.Flyout>
                    <StackPanel Orientation="Horizontal" Spacing="4">
                        <TextBlock Text="ðŸ·ï¸" FontSize="12"/>
                        <TextBlock Text="Tags" Foreground="#AAA" FontSize="12"/>
                    </StackPanel>
                </Button>
                
                <!-- Separator -->
                <Border Grid.Column="4" Width="1" Height="20" Background="#444" Margin="12,0"/>

                <!-- Trim controls inline -->
                <StackPanel Grid.Column="5" Orientation="Horizontal" Spacing="10" Margin="0,0,12,0">
                    <controls:TrimRangeSlider x:Name="TrimSlider" Width="250"
                                              Minimum="0" Maximum="{Binding VideoDuration}"
                                              StartValue="{Binding TrimStart, Mode=TwoWay}"
                                              EndValue="{Binding TrimEnd, Mode=TwoWay}"
                                              VerticalAlignment="Center"/>
                </StackPanel>

                <!-- Export preset -->
                <ComboBox Grid.Column="6" ItemsSource="{Binding ExportPresets}" 
                          SelectedItem="{Binding SelectedPreset}" 
                          Width="100" Background="#222" CornerRadius="4" Margin="0,0,8,0"/>

                <!-- Export button -->
                <Button Grid.Column="7" Content="Export" Command="{Binding ExportClipCommand}" Classes="export-btn"/>
            </Grid>
        </Border>
    </Grid>
</Window>
